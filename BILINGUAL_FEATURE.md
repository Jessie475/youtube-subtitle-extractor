# 雙語字幕提取功能

## 功能概述

現在系統支持同時提取中文和英文字幕（如果影片同時提供兩種語言），並提供多種查看和下載選項。

## 主要功能

### 1. 自動檢測多語言
- 系統會自動檢測影片是否有中文和英文字幕
- 優先提取手動字幕（Manual Subtitles），其次是自動生成字幕（Auto-generated）
- 如果只有一種語言，則只提取該語言

### 2. 多種顯示模式

#### 單語言模式
- 使用標籤頁切換不同語言
- 每次只顯示一種語言的字幕內容

#### 雙語對照模式
- 兩種語言並排顯示
- 中文和英文逐行對照
- 方便學習和對比

### 3. 靈活的下載選項

系統提供多種下載格式：

1. **單一語言下載**
   - 下載中文字幕（單獨文件）
   - 下載英文字幕（單獨文件）

2. **雙語對照下載（逐行）**
   - 中文和英文逐行交替
   - 格式：
     ```
     中文行1
     English line 1
     
     中文行2
     English line 2
     ```

3. **雙語對照下載（並排）**
   - 使用 Tab 分隔兩種語言
   - 可以在 Excel 中打開成兩列
   - 格式：
     ```
     中文	English
     ==================
     中文行1	English line 1
     中文行2	English line 2
     ```

4. **下載全部**
   - 所有語言在一個文件中
   - 每種語言有明確的分隔標記

### 4. 複製功能
- **單語言模式**：複製當前選中的語言
- **雙語對照模式**：複製雙語對照內容（逐行格式）

## 後端改動

### 1. 數據模型更新

新增 `SubtitleItem` 模型：
```python
class SubtitleItem(BaseModel):
    content: str
    language: str
    is_auto_generated: bool = False
```

更新 `SubtitleResponse`：
```python
class SubtitleResponse(BaseModel):
    task_id: str
    status: TaskStatus
    subtitles: Optional[list[SubtitleItem]] = None
    message: str
```

### 2. 提取邏輯改進

新增 `_get_multiple_subtitles()` 方法：
- 優先提取中文（zh-TW, zh-CN, zh-Hans, zh-Hant, zh）
- 優先提取英文（en, en-US, en-GB）
- 優先使用手動字幕，其次使用自動生成字幕
- 如果都沒有，回退到任何可用的字幕

### 3. API 響應格式

`/subtitles/result/{task_id}` 現在返回：
```json
{
  "task_id": "uuid",
  "status": "completed",
  "subtitles": [
    {
      "content": "字幕內容...",
      "language": "zh-TW",
      "is_auto_generated": false
    },
    {
      "content": "Subtitle content...",
      "language": "en",
      "is_auto_generated": false
    }
  ],
  "message": "成功提取 2 個字幕 (zh-TW、en)"
}
```

## 前端改動

### 1. 新增狀態管理
```javascript
const [subtitles, setSubtitles] = useState(null) // Array of subtitle objects
const [selectedLang, setSelectedLang] = useState(0) // Index of selected language
const [viewMode, setViewMode] = useState('single') // 'single' or 'dual'
```

### 2. UI 組件

#### 語言選擇標籤
- 動態生成語言按鈕
- 高亮顯示當前選中的語言
- 如果有兩種語言，顯示「雙語對照」按鈕

#### 字幕預覽
- 單語言模式：顯示選中語言的字幕
- 雙語對照模式：兩種語言逐行顯示，不同顏色區分

#### 下載按鈕組
- 根據可用語言動態生成下載選項
- 清晰的按鈕標籤說明不同的下載格式

### 3. 智能默認行為
- 如果提取到兩種語言，自動切換到「雙語對照」模式
- 如果只有一種語言，保持單語言模式

## 使用場景

### 場景 1：學習英語
1. 輸入有中英文字幕的 YouTube 影片
2. 系統自動提取兩種語言
3. 使用「雙語對照」模式查看
4. 下載「雙語對照（並排）」格式，在 Excel 中學習

### 場景 2：翻譯對比
1. 提取中英文字幕
2. 在「雙語對照」模式下比對翻譯
3. 複製需要的段落

### 場景 3：單語言使用
1. 如果影片只有一種語言，系統自動適應
2. 界面顯示為單語言模式
3. 下載選項簡化為單一下載按鈕

## 兼容性

- 完全向後兼容舊版 API（單語言提取仍然工作）
- 如果影片只有一種字幕，界面自動適應為單語言模式
- 多語言功能為增強功能，不影響現有用戶體驗

## 測試建議

### 測試用例 1：雙語影片
- 使用有中英文字幕的 YouTube 影片
- 驗證兩種語言都被正確提取
- 測試所有下載格式
- 測試雙語對照顯示

### 測試用例 2：單語言影片
- 使用只有中文或只有英文的影片
- 驗證界面正確適應單語言模式
- 驗證下載功能正常

### 測試用例 3：自動生成字幕
- 使用有自動生成字幕的影片
- 驗證標記正確顯示（🤖 圖標）

## 未來改進方向

1. **更多語言支持**
   - 支持日語、韓語、西班牙語等
   - 可配置的語言優先級

2. **高級對照功能**
   - 按時間戳對齊字幕
   - 支持不同步字幕的手動對齊

3. **字幕編輯**
   - 在線編輯字幕內容
   - 調整時間戳
   - 合併或分割字幕行

4. **導出格式**
   - SRT 格式導出
   - VTT 格式導出
   - ASS/SSA 格式導出

## 技術細節

### 語言檢測優先級

**中文檢測順序：**
1. zh-TW（繁體中文-台灣）
2. zh-CN（簡體中文-中國）
3. zh-Hans（簡體中文）
4. zh-Hant（繁體中文）
5. zh（中文通用）

**英文檢測順序：**
1. en（英文通用）
2. en-US（美式英文）
3. en-GB（英式英文）

### 字幕質量優先級
1. Manual Subtitles（手動字幕）
2. Auto-generated Captions（自動生成字幕）
3. Fallback to any available（回退到任何可用字幕）

### 性能優化
- 前端預覽限制前 1500 字符（單語言）或前 50 行（雙語對照）
- 完整內容在下載時才完整處理
- 使用 Blob API 處理大文件下載

## 問題排查

### 問題：只提取到一種語言
**可能原因：**
- 影片確實只有一種字幕
- 另一種語言的字幕是社區貢獻字幕（目前不支持）

**解決方法：**
- 檢查 YouTube 影片設置中是否有多種語言
- 確認字幕不是社區貢獻版本

### 問題：雙語對照行數不匹配
**原因：**
- 不同語言的字幕可能有不同的斷行方式
- 這是正常現象

**說明：**
- 系統會自動補齊空行
- 下載格式已處理此情況

## 總結

這個雙語字幕提取功能大大增強了系統的實用性，特別適合：
- 語言學習者
- 翻譯工作者
- 需要雙語對照的內容創作者
- 字幕研究人員

系統設計遵循漸進增強原則，保持向後兼容，提供直觀的用戶界面，並支持多種使用場景。
